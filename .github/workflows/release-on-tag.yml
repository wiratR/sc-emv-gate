# .github/workflows/release-on-tag.yml
name: Release on Tag

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_macos:
    name: macOS build & release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Point node-gyp to setup-python (macOS)
        run: |
          echo "PYTHON=$pythonLocation/bin/python" >> $GITHUB_ENV
          echo "npm_config_python=$pythonLocation/bin/python" >> $GITHUB_ENV
          $pythonLocation/bin/python -m pip install --upgrade pip setuptools wheel
      - name: Cache Electron caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
      - name: Auto codesign off (no cert)
        run: echo "CSC_IDENTITY_AUTO=true" >> $GITHUB_ENV
      - name: Set version from Git tag
        shell: bash
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "Setting version to $VERSION"
          # à¹€à¸œà¸·à¹ˆà¸­à¸­à¸¢à¸²à¸à¹ƒà¸Šà¹‰à¸•à¹ˆà¸­à¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸–à¸±à¸”à¹„à¸›
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          npm version "$VERSION" --no-git-tag-version
      - name: Install deps (no scripts)
        run: npm ci --ignore-scripts
      - name: Build macOS
        run: npm run build:mac
      
      - name: ðŸ—‘ï¸ Delete existing release (if any)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          echo "TAG=$TAG"
          # à¸–à¹‰à¸²à¸¡à¸µ release à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¹ƒà¸«à¹‰à¸¥à¸šà¸à¹ˆà¸­à¸™ (à¹„à¸¡à¹ˆ error à¸«à¸²à¸à¹„à¸¡à¹ˆà¸¡à¸µ)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Found existing release for $TAG, deleting..."
            gh release delete "$TAG" -y
          else
            echo "No existing release for $TAG"
          fi
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.dmg
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  build_windows:
    name: Windows build & release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Point node-gyp to setup-python (Windows)
        shell: pwsh
        run: |
          $PY = "$env:pythonLocation\python.exe"
          echo "PYTHON=$PY" >> $env:GITHUB_ENV
          echo "npm_config_python=$PY" >> $env:GITHUB_ENV
          & $PY -m pip install --upgrade pip setuptools wheel
      - name: Cache Electron caches
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\AppData\Local\electron\Cache
            C:\Users\runneradmin\AppData\Local\electron-builder\Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
      - name: Set version from Git tag
        shell: bash
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "Setting version to $VERSION"
          # à¹€à¸œà¸·à¹ˆà¸­à¸­à¸¢à¸²à¸à¹ƒà¸Šà¹‰à¸•à¹ˆà¸­à¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸–à¸±à¸”à¹„à¸›
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          npm version "$VERSION" --no-git-tag-version
      - name: Install deps (no scripts)
        run: npm ci --ignore-scripts
      - name: Build Windows
        run: npm run build:win
      
      - name: ðŸ—‘ï¸ Delete existing release (if any) [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          $TAG = "${{ github.ref_name }}"
          Write-Host "TAG=$TAG"

          # à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸¡à¸µ release à¹„à¸«à¸¡
          gh release view $TAG *> $null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Found existing release for $TAG, deleting..."
            gh release delete $TAG -y
          } else {
            Write-Host "No existing release for $TAG"
          }
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.exe
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  build_linux:
    name: Linux build & release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # âœ… à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ python3-distutils (à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸¥à¹‰à¸§à¹ƒà¸™ 24.04)
      - name: Install system deps (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential make g++ pkg-config \
            libx11-dev libxkbfile-dev libsecret-1-dev \
            rpm fakeroot dpkg

      - name: Point node-gyp to setup-python (Linux)
        run: |
          echo "PYTHON=$pythonLocation/bin/python" >> $GITHUB_ENV
          echo "npm_config_python=$pythonLocation/bin/python" >> $GITHUB_ENV
          $pythonLocation/bin/python -m pip install --upgrade pip setuptools wheel

      - name: Cache Electron caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}

      - name: Set version from Git tag
        shell: bash
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "Setting version to $VERSION"
          # à¹€à¸œà¸·à¹ˆà¸­à¸­à¸¢à¸²à¸à¹ƒà¸Šà¹‰à¸•à¹ˆà¸­à¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸–à¸±à¸”à¹„à¸›
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          npm version "$VERSION" --no-git-tag-version

      - name: Install deps (no scripts)
        run: npm ci --ignore-scripts

      - name: Build Linux
        run: npm run build:linux

      - name: ðŸ—‘ï¸ Delete existing release (if any)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          echo "TAG=$TAG"
          # à¸–à¹‰à¸²à¸¡à¸µ release à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¹ƒà¸«à¹‰à¸¥à¸šà¸à¹ˆà¸­à¸™ (à¹„à¸¡à¹ˆ error à¸«à¸²à¸à¹„à¸¡à¹ˆà¸¡à¸µ)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Found existing release for $TAG, deleting..."
            gh release delete "$TAG" -y
          else
            echo "No existing release for $TAG"
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.AppImage
            dist/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
